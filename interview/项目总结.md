# 项目总结

项目架构梳理，面试描述文案梳理清晰(从what/why/how，方案是什么？为什么要这么做？怎么实现的？)

## 小程序动态化方案？

what: 小程序动态化方案是一个动态下发DSL协议到小程序端侧并执行动态化渲染的方案；
why: (发版受限、动态化能力不足)由于淘菜菜小程序受微信发版限制，一直在努力尝试合规发版，但是上线的版本又需要具备一定的动态化能力，能够支撑后续业务的可持续迭代能力。小程序中动态化能力包括了很多例如：搭建投放、webview等动态化能力，但是都存在一定的局限性，搭建投放固定的组件模块，webview不具备原生方法的调用能力。
how: 设置端目的是组件创建和编排，组件通过在线IDE编辑视图、逻辑、样式，并分别通过三种不同转换器将源代码转换成DSL的JSON协议。再通过页面版本和组件编排能力进行统一管理，并上传到CDN。运行时通过下发的三种协议内容进行解析执行，首先渲染器依赖跨端RAX底层Driver DOM层进行跨端组件渲染，也就是我们自定的createElement隐射调用rax的createElement执行组件渲染，差异点在于样式的渲染，因为是动态下发的react object style样式，非前置编译模型，样式只能通过内联样式实现，将下发的对象样式直塞给引用的节点上。执行器则通过下发逻辑层的JSON协议进行从上之下逐级递归执行，边解析结构边执行，举例：let a = 1 + 2，首先let a（JSON结构{type: 'let', name: 'a'}会被申明到JSVM的自定义作用域(数组结构)环境中a变量并赋值为undefined，右侧为赋值表达式描述成{type: 'exp', left: '1', operate: '+', 'right': '2'}，解析执行操作运算符left + right的逻辑并返回，赋值到作用域内的a变量上。

## 端智能商品重排方案？

what: 端智能是对用户在会话中的行为特征进行实时预测，商品重排是端智能中实现的一个场景，即通过用户的行为特征结合对未曝光商品进行重排序。
why: (滞后性、高成本)现有的推荐算法是通过离线的T+1埋点信息进行模型训练，针对用户感兴趣行为特征有严重的滞后性，导致推荐的商品不符合用户的要求。且流量集中式训练和推理会给云端计算服务带来巨大的成本，降低推理效率。
how: 方案分两部分策略中心、端计算；策略中心由云端节点编排下发和C端特征清洗与节点匹配。端计算侧由端计算脚本和重排模型；以重排方案为例：目的是对未曝光商品进行重排，行为路径为feeds商品点击进入商详然后回到首页feeds的场景，所以策略中心会配置一条该行为路径下发到端侧，端侧通过清洗的行为特征输出该会话下的事件节点队列，然后通过下发的特征节点与事件队列进行匹配(优先从最后一个节点进行倒叙匹配)，匹配中了全链路规则后触发端侧脚本，端侧Python脚本会从已清洗的数据特征中取出特征与缓存商品池（未曝光商品太少对用户效果不好）的数据同时入参给排序模型，然模型给缓存商品池的每个品进行打分，按照打分的高低排序返回重排商品序列，进行端侧商品渲染。（首页Feeds数据结论：CTR +3.4%，UV价值 +1.6%，人均成交笔数 +2.5% ）

## 微信小程序免登方案？

what: 微信小程序免登方案是打通小程序与小程序webview之间登录态的方案
why: 受微信发版限制，线上版本小程序和webview之间环境相互隔离（小程序和webview实现原理和架构不同），导致登录态不能互通。
how: 如果能正常发版的情况下，免登方案是非常简单的事，在小程序webview初始化前进行获取免登授权的链接，再初始化的时候就可以给webview种上cookie信息实现免登。不能发版的情况怎么进行免登呢？好在小程序中有一中间页（当时目的是为了淘菜菜用增分享出去的活动链接参数太长导致微信被截断无法正常显示，因此链接参数被存储到服务端，然后进中间页时查询参数进行重定向），利用这一点我们将要跳转的webview页面前置都加上这个Redirect跳转路径，接口在发起请求参数的时候，获取到小程序的上下文登录态，然后将该场景的请求转发到我们的FaaS SSR服务上，FaaS层通过用户的登录信息到中台服务换H5登录的cookie信息，然后由SSR模版输出服务端页面，页面主要目的是种上免登的cookie信息，并302重定向到webview实际打开的页面，此时页面就具备了cookie信息和登录态了

## 微信全域攻防方案？

what: 微信攻防方案其实是针对微信做一些灵活的应急方案，降低因微信封禁带来的不可控影响。
why: 在微信场景下运营H5页面，时常因微信规则和用户恶意举报，致使页面不可访问。经总结分析封禁为页面访问域名，因此我们做了动态域名方案。
how: 全域攻防方案包括：动态域名方案、小程序域名应急方案、universalLink唤端应急方案。动态域名方案的实现原理(场景发生更频繁)：动态化域名方案目的是为了快速应急微信被封的域名，为业务快速止血。
    实现原理：考虑需要大量的域名池做备用，传统的方案是：域名统一接入(域名识别IP后为阿里IP被封可能性增加)+业务部署Nginx环境（维护成本大,风险也大）；动态域名方案以CDN + ER的方案做动态域名请求前端应用，只需将域名接入到CDN上，统一接入时申请了根域名的三级泛域名规范，将申请的泛域名cname到配置的CDN域名上，(如：*.hemajs.com)执行CDN资源服务，使(a.hemajs.com/b.hemajs.com都可以访问) 解决了动态域名问题，然后通过ER(EdgeRoutine)进行流量监控上报，并加载CDN资源返回，稳定性通过部署crontab定时脚本检测域名池的有效性，并及时替换。微信H5再向外分享时优先根据分享场景获取动态域名分享，将各个分享的域名进行离线访问流量，防止微信识别为机器流量被封禁。

## 首屏性能优化方案？

优化方案包括：小程序(5s+) -> ESR、快照、PHA(TabBar优化方案)、商详预请求、端侧DNS预请求、端侧webview的预加载等
为什么要小程序走 H5 方案：
1、性能问题(首屏冷启动 5s+，热启动也需要 3s，首屏打开率 60%)
2、工程复杂性(多人共同开发一个项目，项目分险搞)
3、手淘内更多的 H5 性能优化方案实践，小程序
4、小程序方案已经做到业务没有持续优化的空间了。

ESR：ESR方案是通过边缘计算和缓存技术来降低SSR风险，如果容器响应不及时或发生请求异常等会降级到CSR模式。ESR通过部署在CDN边缘节点的V8环境来处理请求事件响应或转发，在ER层我们采用流式渲染模式(opening-stream)，将首页分两段式传输：第一段缓存在ER节点上的骨架静态模版提高首屏访问效率减少白屏率；第二段，在第一段返回的同时并行发起第二段的首屏资源请求，FaaS在第二屏模块中增加删除骨架屏的节点，并上屏SSR内容。
快照：通过端侧缓存上一屏


